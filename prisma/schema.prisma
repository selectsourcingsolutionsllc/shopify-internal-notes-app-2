generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model ProductNote {
  id          String   @id @default(cuid())
  productId   String
  shopDomain  String
  content     String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String
  updatedBy   String
  photos      ProductNotePhoto[]
  auditLogs   AuditLog[]
  
  @@index([productId, shopDomain])
}

model ProductNotePhoto {
  id            String      @id @default(cuid())
  noteId        String
  url           String
  thumbnailUrl  String?
  filename      String
  uploadedAt    DateTime    @default(now())
  uploadedBy    String
  note          ProductNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId])
}

model OrderAcknowledgment {
  id              String   @id @default(cuid())
  orderId         String
  productId       String
  shopDomain      String
  acknowledgedBy  String
  acknowledgedAt  DateTime @default(now())
  proofPhotoUrl   String?
  proofPhotoName  String?
  noteId          String   // Required - each acknowledgment is for a specific note
  sessionId       String?  // Tracks which browser session created this acknowledgment
  auditLogs       AuditLog[]

  @@unique([orderId, noteId])
  @@index([orderId, shopDomain])
}

model AuditLog {
  id                    String               @id @default(cuid())
  shopDomain            String
  userId                String
  userEmail             String?
  action                String               // CREATE, UPDATE, DELETE, ACKNOWLEDGE
  entityType            String               // PRODUCT_NOTE, ACKNOWLEDGMENT
  entityId              String
  oldValue              Json?
  newValue              Json?
  timestamp             DateTime             @default(now())
  productNoteId         String?
  productNote           ProductNote?         @relation(fields: [productNoteId], references: [id])
  acknowledgmentId      String?
  orderAcknowledgment   OrderAcknowledgment? @relation(fields: [acknowledgmentId], references: [id])
  
  @@index([shopDomain, timestamp])
  @@index([entityType, entityId])
}

model AppSetting {
  id                     String   @id @default(cuid())
  shopDomain             String   @unique
  requireAcknowledgment  Boolean  @default(true)
  requirePhotoProof      Boolean  @default(false)
  blockFulfillment       Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model BillingSubscription {
  id                String   @id @default(cuid())
  shopDomain        String   @unique
  subscriptionId    String   @unique
  chargeId          String?  // Shopify's charge_id from return URL
  planName          String?  // e.g., "Starter Plan", "Pro Plan", etc.
  status            String   // ACTIVE, CANCELLED, EXPIRED, PENDING, FROZEN
  test              Boolean  @default(false) // Is this a test charge?
  trialStartedAt    DateTime? // When trial started (prevents reinstall exploit)
  trialEndsAt       DateTime?
  currentPeriodEnd  DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model OrderReleaseAuthorization {
  id          String   @id @default(cuid())
  orderId     String
  shopDomain  String
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  consumed    Boolean  @default(false)

  @@unique([orderId, shopDomain])
  @@index([orderId, shopDomain])
}

model ShopInstallation {
  id              String    @id @default(cuid())
  shopDomain      String    @unique
  installedAt     DateTime  @default(now())
  uninstalledAt   DateTime? // When app was uninstalled (null if still installed)
  onboardingStep  Int       @default(0) // Track setup wizard progress
  firstBillingAt  DateTime? // When they first subscribed (for analytics)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model WebhookEvent {
  id          String   @id @default(cuid())
  shopDomain  String
  topic       String   // e.g., APP_SUBSCRIPTIONS_UPDATE, APP_UNINSTALLED
  payload     Json     // Raw webhook payload
  processedAt DateTime @default(now())
  success     Boolean  @default(true)
  errorMsg    String?  // Error message if processing failed

  @@index([shopDomain, topic])
  @@index([processedAt])
}