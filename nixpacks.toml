[variables]
NIXPACKS_NO_CACHE = "1"

[phases.setup]
nixPkgs = ["nodejs_22"]

[phases.install]
cmds = ["npm ci --include=dev --cache=/tmp/.npm"]

[phases.build]
cmds = [
  "echo \"Starting fresh build at $(date +%s)\"",
  "rm -rf build public/build .cache",
  "npx prisma generate",
  "npm run build",
  "echo \"Build completed at $(date)\" > build/BUILD_TIMESTAMP.txt",
  "cat build/BUILD_TIMESTAMP.txt"
]

[start]
cmd = "npx prisma migrate deploy && npm run start"